<!DOCTYPE html>
<html lang='en'>
<head>
    <meta charset='UTF-8'>
    <title>pOTsearch</title>
    <meta name='viewport' content='width=device-width, initial-scale=1'>

    <link rel='stylesheet' href='//cdn.rawgit.com/necolas/normalize.css/master/normalize.css'>
    <link rel='stylesheet' href='//cdn.rawgit.com/milligram/milligram/master/dist/milligram.min.css'>

    <style type='text/css'>
        body {
            color: black;
        }


        #results .row {
            border-top: 1px solid grey;
        }

        a.field-snippet {
            color: black;
        }

        label {
            display: inline;
            font-size: 100%;
            font-weight: normal;
            margin: 0;
        }

        select {
            width: auto;
        }
    </style>
</head>
<body>


<div class='container'>
    <div class='row row-center' style='margin: 1em 0; color: #606c76;'>
        <div class='column' style='text-align: center'>
            <h1 style='margin-bottom: 0'>pOTsearch</h1>
            <em>— kein Mensch braucht Google —</em>
        </div>
    </div>
    <div class='row'>
        <div class='column column-100'>
            <input id='query' placeholder='Suche…'>
        </div>
    </div>
    <div class='row'>
        <div class='column'>
            <div style='display: none;'> <!-- psssht, beta! -->
                Suche nach
                <input type='radio' name='type' id='type-post' checked='checked'>
                <label for='type-post'>Posts</label>
                <input type='radio' name='type' id='type-thread'>
                <label for='type-thread'>Threads</label>
            </div>

            <div class='float-right'>
                Sortieren nach

                <select id='sort'>
                    <option value='score'>Relevanz</option>
                    <option value='pid-desc'>Neueste zuerst</option>
                    <option value='pid-asc'>Älteste zuerst</option>
                </select>
            </div>
        </div>

    </div>
    
    <div class='row' style='display: none;' id='results-intro'>
        <div class='column'>
            <span id='field-count'></span> Ergebnisse in <span id='field-elapsed'></span>&nbsp;s gefunden,
            zeige nur die ersten <span id='field-shown'></span>.
        </div>
    </div>

    <div id='results'>

    </div>
</div>

<template id='post-template'>
    <div class='row'>
        <div class='column'>
            <strong class='field-title'></strong>
            <a href='' class='field-snippet'></a>
        </div>
        <div class='column'>
            Im Thread: <span class='field-thread'></span><br>
            Von: <a href='' class='field-user'></a>
        </div>
    </div>
</template>

<template id='thread-template'>
    <div class='row'>
        <div class='column'>
            <strong><a href='' class='field-title'></a></strong><br>
            ( <span class='field-subtitle'></span> )<br>
    </div>
</template>

<script type='text/javascript'>
    document.addEventListener('DOMContentLoaded', function() {
        var query_input = document.getElementById('query');
        query_input.addEventListener("keyup", function (event) {
            if (event.code === "Enter") {
                input_changed();
            }
        });

        document.getElementById('type-post').onchange = input_changed;
        // deselecting a radio button does not count as a change as per HTML
        document.getElementById('type-thread').onchange = input_changed;
        document.getElementById('sort').onchange = input_changed;

        if (query_input.value.length) {
            input_changed();
        }
    });

    function input_changed() {
        var query = document.getElementById('query').value;
        var type = document.getElementById('type-post').checked ? 'post' : 'thread';
        var sort = document.getElementById('sort').value;

        do_search(query, type, sort)
    }

    function do_search(query, type, sort) {
        var xhr = new XMLHttpRequest();
        xhr.open('GET', '../api/search?content=' + encodeURIComponent(query) + '&type=' + type + '&sort=' + sort, true);
        xhr.onreadystatechange = function () {
            // lol fehlerbehandlung
            if (xhr.readyState == 4 && xhr.status == 200) {
                var results = JSON.parse(xhr.responseText);
                display_results(results);
            }
        };
        xhr.send();
    }

    function display_results(results) {
        var result_rows = document.getElementById('results');
        clear_node(result_rows);

        console.log(results);

        document.getElementById('field-count').textContent = results.count;
        document.getElementById('field-shown').textContent = results.results.length;
        document.getElementById('field-elapsed').textContent = results.elapsed.toFixed(3);
        document.getElementById('results-intro').style = '';

        if (results.type === 'post') {
            var post_template = document.getElementById('post-template');
            for (var i = 0; i < results.results.length; i++) {
                var result = results.results[i];
                var row = document.importNode(post_template.content, true);
                row.querySelector('.field-title').textContent = ''; // fixme
                row.querySelector('.field-snippet').innerHTML = result.snippet;
                row.querySelector('.field-snippet').href = 'http://forum.mods.de/bb/thread.php?TID=' + result.thread.tid + '&PID=' + result.pid + '#reply_' + result.pid;
                row.querySelector('.field-thread').textContent = result.thread.title + ' (' + (result.thread.subtitle || '') + ')';
                row.querySelector('.field-user').textContent = result.user.name;
                row.querySelector('.field-user').href = 'http://my.mods.de/' + result.user.uid;
                result_rows.appendChild(row);
            }
        } else {
            var thread_template = document.getElementById('thread-template');
            for (var i = 0; i < results.results.length; i++) {
                var result = results.results[i];
                var row = document.importNode(thread_template.content, true);
                row.querySelector('.field-title').textContent = result.title;
                row.querySelector('.field-title').href = 'http://forum.mods.de/bb/thread.php?TID=' + result.tid;
                row.querySelector('.field-subtitle').textContent = result.subtitle;
                result_rows.appendChild(row);
            }
        }
    }

    function clear_node(node) {
        while (node.firstChild) {
            node.removeChild(node.firstChild);
        }
    }
</script>

</body>
</html>